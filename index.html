<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- <script src="https://psyc241.ucsd.edu/Chaipat/TB_PCL_vWM_delays/js/vismemCC.js"></script>  -->
<script src="https://timbrady.org/turk/TimTurkTools.js"></script>
<script src="js/vismemCC_simon.js"></script>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">


<style>
    .trialDiv {
      /* border: 2px solid gray;*/
      border: 0px;
      padding: auto;
      width: auto;
      position: relative;
      top: 50px;
      left: 50%;
      /* bring your own prefixes */
      transform: translate(-50%, -50%);
      text-align: center;
      display: none;
      margin-top: 150px;
    }

    body {
      font-family: Arial, Helvetica;
      font-size: 18pt;
      background-image: linear-gradient(180deg, slategray, darkgray);
      height: 100%; 
      /*background-color: slategray;*/
      /*background-image: url("pic/61ce0c2a48c65.jpg");*/
    }

    #submitButton {
      display: none;
    }

    #introductions {
      width: 60%;
      margin: 0 auto;
      text-align: center;
      margin-top: 100px;
    }

    .instructions {
      width: 60%;
      margin: 0 auto;
      text-align: top;
      margin-top: 250px;
    }

    #startExperiment {
      color: rgb(200,200,200);
      text-decoration: none;
    }

    #startExperiment:hover{
      color: white;
    }

    #startExperimentButton {
      width: 200px;
      text-align: center;
      border: 4px outset gray;
      background: gray;
      padding: 5px;
      margin: 0 auto;
    }

    .continueExp:hover{
      color: white;
    }

    .continueExp {
      color: rgb(200,200,200);
      text-decoration: none;
    }

    .continueButton {
      width: 100px;
      text-align: center;
      border: 4px outset gray;
      background: gray;
      padding: 5px;
      margin: 0 auto;
    }

    #meter{
    width: 10cm;
    height: 10cm;
    }

    .instr {
      display: none;
    }
    #done {
    display: none;
    }

</style>



<div id="done" class="taskDiv">
Saving data...
</div>


<input type="submit" value="Submit" name="submitButton" id="submitButton" style="display: none">

<audio id="audio1" src="sounds/click.mp3"></audio>
<audio id="audio2" src="sounds/click.mp3"></audio>
<audio id="audio3" src="sounds/click.mp3"></audio>
<audio id="audio4" src="sounds/click.mp3"></audio>
<audio id="audio5" src="sounds/click.mp3"></audio>
<audio id="audio6" src="sounds/click.mp3"></audio>
<audio id="audio7" src="sounds/click.mp3"></audio>
<audio id="audio8" src="sounds/click.mp3"></audio>
<audio id="audio9" src="sounds/click.mp3"></audio>

<audio id="do" src="sounds/do.wav"></audio>
<audio id="re" src="sounds/re.wav"></audio>
<audio id="fa" src="sounds/fa.wav"></audio>
<audio id="mi" src="sounds/mi.wav"></audio>
<audio id="sol" src="sounds/sol.wav"></audio>
<audio id="la" src="sounds/la.wav"></audio>
<audio id="ti" src="sounds/ti.wav"></audio>
<audio id="click" src="sounds/click.mp3"></audio>

<audio id="backgroundsound" src="sounds/ocean-waves.wav"></audio>
<audio id="backgroundsound2" src="sounds/dreamscape.wav"></audio>


<div id="introductions">
  <p>ต่อจากนี้จะมีวิธีการเล่นเกมปรากฏขึ้น
    <br>ขอให้ท่านสำรวจสถานที่ที่ท่านอยู่ว่า
    <br>มีสิ่งที่รบกวนสมาธิของท่านหรือไม่</p>
    
    <p>หากท่านอยู่ในสถานที่ที่พร้อมแล้ว
        <br>โปรดกดปุ่ม "เข้าสู่การทดสอบ" เพื่อไปต่อ</p>
  
  <div id="startExperimentButton">
    <a href="#" id="startExperiment">เข้าสู่การทดสอบ</a>
  </div>
  
  <p></p>


  <div id="consent" style="height:120px; border:1px solid #ccc;font:12px Arial, Helvetica; overflow:auto" align="justify">
    <p align="center"><b>UNIVERSITY OF CALIFORNIA, SAN DIEGO
    <br>CONSENT TO ACT AS A RESEARCH SUBJECT</b>

    <p>
    <br> Timothy Brady, Ph.D., is conducting a research study to find out more about attention, memory and vision.  You have been asked to participate because you are a healthy young adult.  There will be approximately 1600 participants in this study this year. The expected duration of the study is 5 years, though your participation will last only between 3 minutes and 45 minutes, with the exact expected timing listed in the HIT description.</p>

    <p>
    <br><b>PROCEDURES.</b> If you agree to participate in this study by accepting this HIT and continuing in the task, the following will happen to you:
    <br> &emsp; 1. You will be shown displays of letters, words, or pictures, right here in your web browser. 
    <br> &emsp; 2. You will try to perceive and remember these stimuli, and respond by pressing keys or moving and clicking the mouse in a manner that we will describe to you.</p>

    <p>
    <br> <b>RISKS.</b> You will be required only to continue to interact with your web browser and make responses for a short duration. Thus, no potential risks or discomforts are anticipated except for the possibility that some tasks may be slightly boring. However, there may be risks that are currently unforeseeable.</p>

    <p>
    <br><b>PAYMENT/REMUNERATION.</b> In consideration of your time, you will receive payment at the rate described through the Amazon Mechanical Turk system. Compensation will range from $0.60 (for a 3 min task) up to as much as $8 (for a task that takes 45 min), with rates between $8/hr and $12/hr. The exact payment rate for this HIT is provided in the HIT description.</p>

    <p>
    <br><b>RIGHTS.</b> You may call the UCSD Human Research Protection Program at 858-657-5100 to ask about your rights as a research subject or to report research-related problems.</p>

    <p>
    <br><b>BENEFITS.</b>  There will be no direct benefit to you from these procedures.  However, the investigator may learn more about basic questions pertaining to attention, memory and vision.   This knowledge may have benefits to society in fields ranging from improving education to visual design, but these benefits will be indirect.</p>

    <p>
    <br><b>EXPLANATION.</b>  The researcher has explained this study to you and answered your questions.  If you have questions about the research or research-related problems, including any adverse events, you may reach Dr. Timothy Brady at timbrady@ucsd.edu or 858-822-4530.</p>

    <p>
    <br><b>VOLUNTARY NATURE OF PARTICIPATION.</b>  Participation in research is entirely voluntary.  You may refuse to participate or withdraw at any time without penalty. The alternative to participation is to choose not to participate.</p>

    <p>
    <br><b>CONFIDENTIALITY.</b>  Research records will be kept confidential to the extent allowed by law.  As with all research, there is also the possibility of loss of confidentiality.  Information from participants such as yourself will be identified by a subject number, which is not associated with your identity, by the researchers, to minimize the potential loss of confidentiality.</p> 

    <p>
    <br>By clicking “I agree”, you are indicating that you are at least 18 years old, have read this consent form and agree to participate in this research study. Please print a copy of this page for your records.</p>
    </p>
  </div>
</div>


<div align="center">
    <canvas id="myCanvas"  width="600" height="600" style="cursor:default;border:none;outline-width:2px;outline-color:#000000">
    </canvas>
    <p id="instr"></p>
</div>


<div id='frame1' class='trialDiv'>
  <div class = "instructions"> 
    <p>จะมีรูปวงกลมทั้งหมด 6 รูป</p>
        <p>เมื่อพื้นหลังสีฟ้าปรากฏ</p>
        <p>ให้ท่านจำวงกลมที่ถูกกด <b><i>ตามลำดับ</i></b></p>
        <p>หลังจากนั้นให้ท่านกดวงกลม <b><i>ตามลำดับ</i></b> ที่จำไว้</p>
        <p>แต่หากพื้นหลังสีแดงปรากฏ</p>
        <p>ให้ท่านจำวงกลมที่ถูกกด <b><i>ตามลำดับ</i></b></p>
        <p>หลังจากนั้นให้ท่านกดวงกลม <b><i>ย้อนหลัง</i></b> ตามลำดับที่จำไว้</p>
    <div class="continueButton">
      <a href="#" id="cont1" class="continueExp"> เริ่มการทดสอบ </a>
    </div>
  </div>
</div>

<div id='frame2' class='trialDiv'>
    <p> 
    <br> อะไรจะโผล่มาแบบนี้
    <br> พยายามจำตำแหน่งเอาไว้

    <div class="continueButton">
      <a href="#" id="cont2" class="continueExp"> ไปค่ะพี่สุชาติ </a>
    </div>
</div>

<div id='frame3' class='trialDiv'>
    <p> 
    <br> แล้วก็จะหายไป
    <br>

    <div class="continueButton">
      <a href="#" id="cont3" class="continueExp"> ไปค่ะพี่สุชาติ </a>
    </div>
</div>

<div id='frame4' class='trialDiv'>
    <p> 
    <br> พอมีสัญญาณให้ตอบก็ตอบได้เลย
    <br> กดลงไปบนกลมๆที่มองเห็นได้เลยเพื่อตอบ 

    <div class="continueButton">
      <a href="#" id="cont4" class="continueExp"> ไปค่ะพี่สุชาติ </a>
    </div>
</div>

<div id='frame5' class='trialDiv'>
    <p> 
    <br> จะเป็นเช่นนี้ไปเรื่อยๆ 
    <br> พร้อมไหม

    <div class="continueButton">
      <a href="#" id="cont5" class="continueExp"> ไปค่ะพี่สุชาติ </a>
    </div>
</div>

<div id='rule0' class='trialDiv'>
    <p> 
    <br> ถ้าพื้นหลังเป็น <font color=darkgreen> <b>สีเขียว</b> </font> ให้กดปุ่ม <b>ตามลำดับ</b> ที่จำไว้
    <br> ถ้าพื้นหลังเป็น <font color=darkred> <b>สีแดง</b> </font> ให้กดปุ่ม <b>ย้อนกลับ</b> จากลำดับที่จำไว้

    <br> <br> กรุณาใช้ <b>เมาส์</b> กดลงบนปุ่ม </p>
</div>

<div id='rule1' class='trialDiv'>
    <p> 
    <br> ให้กดปุ่มย้อนกลับจากลำดับที่จำไว้
    <br> 
    <br> <br> กรุณาใช้ <b>เมาส์</b> กดลงบนปุ่ม </p>
</div>



<p id="debug"></p> 
        <form id="record" action="examplePause.php" name="nextpage" method="post"> 
            <input type="hidden" id="targ" name="targ" value='[0,0,0,0,0,0,0,0,0,0,0,0]'>
            <input type="hidden" id="resp" name="resp" value='[0,0,0,0,0,0,0,0,0,0,0,0]'>
            <input type="hidden" id="targAng" name="targAng" value='[0,0,0,0,0,0,0,0,0,0,0,0]'>
            <input type="hidden" id="respAng" name="respAng" value='[0,0,0,0,0,0,0,0,0,0,0,0]'>
            <input type="hidden" id="rt" name="rt" value='0'>
        </form>


        <script type="text/javascript">
          
          // Settings
          var code = "CC" + Math.round(Math.random()*100000) + "92";
          var task='Simon';
          var c1=document.getElementById("myCanvas");
          var ctx1=c1.getContext("2d");   
          var centerX=c1.width/2;
          var centerY=c1.height/2;   
          var width=c1.width;
          var height=c1.height;
          var objSize=60;
          var objDist=180; 
          var visualang = Math.round((Math.atan(((objSize))/objDist))*(180/Math.PI));
          // var wheelRad=objSize+objDist+30;
          var nubX=null;
          var nubY=null;
          var nTrials = 100;
          var numDots=6;
          var thetadiff = 360/numDots;
          var nSeq = 3;
          var circRot= 0;
          // var colRot= 0;
          var circcolor = '#D3D3D3';    // light gray
          var hovercolor = '#FFFFFF';   // dark gray
          var clickedcolor = '#FFFFFF'; // white
          var circborder = '#000000';   // black
          // var soundlists = ['click'];
          var soundlist = []; 
          // for (var iSeq =0; iSeq<nSeq;iSeq++){soundlist[iSeq] = soundlists[iSeq]}

          var beeplist = ['audio1','audio2','audio3','audio4','audio5','audio6','audio7','audio8','audio9'];

          var beeps = []; for (var isound = 0; isound < nSeq; isound++){beeps[isound] = document.getElementById(beeplist[isound])};
          var nullcolor = []; for (var idot =0; idot<numDots;idot++){nullcolor[idot] = circcolor}
          var borders = []; for (var idot =0; idot<numDots;idot++){borders[idot] = circborder}
          const testtemp = []; for (var idot =0; idot<numDots;idot++){testtemp[idot] = 99999}

          const stimdur = 500;
          const delay = 500;

          var rt=[];
          var moveLast=0;
          
          var initTime=3000;
          var presTime=1000;
          var delayTime=1000;
          var feedbacktime=1000;

          const bgcolor = ["#f1959b","#8abaae"];
          var bgx = Math.round(Math.random());
          var isTest=false;
          var isTrain = false;
          var iamin = false;
          var currProbe=-1;
          var realstimtime =[]; 
          var realdelaytime =[];

          var bgcolorList = []; //Array of background color since start
          var curTrial = 0;
          var stackLog = false; //Stacking logic for wrong answer (for repeating trials)
          
          // Define positions before rotation
          xTemp=[];
          yTemp=[];
          var theta = [];
          for(i=0;i<numDots;i++){
              theta.push(Math.round(( ((2*Math.PI/numDots)*i))*(180/Math.PI)))
              xTemp.push(objDist*Math.cos((2*Math.PI/numDots)*i));
              yTemp.push(objDist*Math.sin((2*Math.PI/numDots)*i))
          }

          // Rotate positions
          xPos=[];
          yPos=[];
          
          for(i=0;i<numDots;i++){
              xPos.push(centerX-(Math.cos(circRot)*xTemp[i])+(Math.sin(circRot)*yTemp[i]));
              yPos.push(centerY+(Math.sin(circRot)*xTemp[i])+(Math.cos(circRot)*yTemp[i]))
          }

          function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;

            // While there remain elements to shuffle...
            while (0 !== currentIndex) {

              // Pick a remaining element...
              randomIndex = Math.floor(Math.random() * currentIndex);
              currentIndex -= 1;

              // And swap it with the current element.
              temporaryValue = array[currentIndex];
              array[currentIndex] = array[randomIndex];
              array[randomIndex] = temporaryValue;
            }
            return array;
          }

          function paintcolor(colAng){
            var color=[];
            for(ic=0;ic<colAng.length;ic++){
                if (colAng[ic] == 99999){
                    color[ic]=circcolor
                }else{
                    color[ic]=angle2HEX(colAng[ic])
                }
            }
            return color 
          }

          function paintborder(colAng){
            var color=[];
            for(ic=0;ic<colAng.length;ic++){
                if (colAng[ic] == 99999){
                    color[ic]=circborder
                }else{
                    color[ic]=angle2HEX(colAng[ic])
                }
            }
            return color 
          }

          function makeCircles(currColor,bordercolor){
            /** Create circles with specified color arrays 
            *@param {string[]} currColor Facecolor of circle
            *@param {string[]} bordercolor bordercolor of circle
            **/

            for(i=0;i<numDots;i++){
                makeCircle('dot'+i,xPos[i],yPos[i],objSize+2,false,0,bordercolor[i],bordercolor[i]); //border slightly larger than circle
                makeCircle('dotIn'+i,xPos[i],yPos[i],objSize,false,0,currColor[i],currColor[i]);
            }
          }

          function makeBackground(bgcolor,width = 600, height = 600){
            /** Make background for task
            *@param {string} bgcolor color of background
            *@param {number} width width of background
            *@param {number} height height of background
            **/
                makeRectangle('bg',centerX,centerX,width,height,false,bgcolor,bgcolor);
          }

          function makeCrosshair(length = 40, width = 6){
            /** Create crosshair for fixation **/
            for(i=0;i<numDots;i++){
                makeRectangle('cross1',centerX,centerX,width,length,false,'#000000','#000000');
                makeRectangle('cross2',centerX,centerY,length,width,false,'#000000','#000000');
            }
          }

          var st=null; //starting time
          function startTime(){
            /** put value to st **/
              var d = new Date();
              st=d.getTime();
          }

          function endTime(){
              /** Calculate time differences from starting point of test **/
              var d = new Date();
              timeDif=d.getTime()-st;
              return timeDif;
          }
          
          function trialIsOver() {
              
              // Initial
              erase(ctx1);
              clear();
              makeBackground(bgcolor[bgx])
              makeCrosshair();
              drawObjects(ctx1,objects);
              // var curtrialStruct = {};
              
              // curtrialStruct.colordist = colordist;
              // curtrialStruct.stimdur = stimdur;
              // curtrialStruct.delaytime = alltrldel[curTrial];
              // curtrialStruct.targcol = alltrlseq[curTrial];
              // curtrialStruct.testpos = alltstpos[curTrial];
              // curtrialStruct.trlrot = alltrlrot[curTrial];
              // curtrialStruct.colorwrot = allcolorwrot[curTrial];
              // curtrialStruct.tarcode = alltarcode[curTrial];
              // curtrialStruct.resp = allselCol[curTrial];
              // curtrialStruct.respAng = allcolAng[curTrial];
              // curtrialStruct.rt = rt[curTrial];
              // curtrialStruct.realstim = realstimtime[curTrial];
              // curtrialStruct.delaytimeReal = realdelaytime[curTrial];
              // trialStruct.push(curtrialStruct);


              // document.getElementById('targ').value=JSON.stringify(color);
              // document.getElementById('resp').value=JSON.stringify(selColor);
              // document.getElementById('respAng').value=JSON.stringify(selAng);
              // document.getElementById('targAng').value=JSON.stringify(targAng);
              // document.getElementById('rt').value=JSON.stringify(rt);

              curTrial = curTrial+1 ;
              //#region update trial parameter
              /**
               * updateAnsState
               * updateBGX
               * updateNSeq
               **/
              //#endregion

              if (curTrial >= nTrials){
                  Done();
                  // $('#submitButton'.show());
              } else {
                  // var selColor=[];var selAng=[];
                  // for (var item=0;item<numDots;item++){selColor[item]='#FFFFFF';selAng[item]=null};
                  // $('#rule0').hide();
                  // $('#rule1').hide();
                  showTrial();
                  startTrialTime = new Date();
              }

          }
          //#region Randomized background change
          function updateBGX(ansState,consCorr){
            /**
             * Update prompting background color
             * @param {Boolean} ansState Answer state of previous trial: True for correct
             * @param {Int} consCorr Consecutive correct trial
             **/
            const rampProb = 0.2; //Ramping rate for switching probability of consecutive correct trial
            const initProb = 0.2; //Inititial switching probability for correct trial 
            const falseProb = 1.0;

            var switchingNum = Math.random();
            var thresholdNum;
            
            // If correctly answer the trial question
            if (ansState === true) {
              thresholdNum = initProb + (consCorr-1)*rampProb;
            }
            else if (ansState === false) {
              thresholdNum = falseProb;
            } else {
              throw "Wrong ansState";
            }

            //#region log
            console.log(switchingNum);
            console.log(thresholdNum);
            //#endregion

            if (switchingNum < thresholdNum) {
              bgx = Math.abs(bgx-1);
              //#region log
              console.log("bgx flipped");
              //#endregion
            }
          }
          //#endregion 
          
          //#region Update answer states (for visualization)
          function updateAnsState(ansState,consCorr) {
            if (typeof(ansState)=='boolean') {
              if (ansState) {
                consCorr+= 1;
                } else {
                  consCorr = 0;
                }
              } else {
                throw "Wrong answer states"
            }
          }
          //#endregion
          
          //#region stacking logic
          function flipStackingLogic() {
            stackLog = stackLog ? false : true;
          }
          //#endregion

          //#region Update the length of the sequences
          function updateNSeq(ansState,consCorr) {
            if (typeof(ansState)=="boolean") {
              if ((ansState) && (consCorr ==2)) {
                nSeq +=1;
              } else if (!ansState) { 
                //Do nothing
              }
            } else {
              throw "Wrong answer states"
            }
            
          }
          //#endregion


          function showTrial(){
            // isTest indicator for testing state: true for playable, and false for instruction and others.
            isTest = false;
            if (curTrial == 0) {
                    bgx = 1;
                }
             erase(ctx1);
             //clear();
             makeCircles(nullcolor,borders);
             makeCrosshair();
             drawObjects(ctx1,objects);
             makeBackground(bgcolor[bgx]);

             // Shuffle(soundlist);
             var xx = Math.floor(Math.random()*360);

             //dot sequences constructions
             const dotid = []; 
             for (var idot =0; idot<numDots;idot++){
               dotid[idot] = idot
             }

             var testcolors = [];

             //#region create paint color for all 6 circles as array of color
             //nSeq defines to length of each sequences
             for (var iSeq=0; iSeq < nSeq; iSeq++) {
                const temp = Object.values(Object.assign({}, testtemp));
                if (iSeq ==0){
                  //Copy instances from dotid to updateArr and then shuffle the id
                  const updateArr = Object.values(Object.assign({}, dotid));
                  shuffle(updateArr)

                  var lastpos = [updateArr[0]]

                }
                else {
                  const updateArr = Object.values(Object.assign({}, dotid)); 
                  updateArr.splice(lastpos[lastpos.length-1],1) //delete one element from updateArr at index of lastpos[lastpos.length-1]
                  shuffle(updateArr)
                  lastpos.push(updateArr[0])
                }
                temp[lastpos[iSeq]] = xx;
                //console.log(lastpos); [1] [1,2] [1,2,5] for 3 iterations
                tempcolor = paintcolor(temp);
                //console.log(temp); [99999, 337, 99999, 99999, 99999, 99999]
                testcolors.push(tempcolor);
                //console.log(tempcolor); ['#D3D3D3', '#ff5d73', '#D3D3D3', '#D3D3D3', '#D3D3D3', '#D3D3D3']
             }
             //#endregion
             
             setthistime = [initTime];
             for (iSeq=0;iSeq < nSeq; iSeq++){ 
                setthistime.push(setthistime[setthistime.length-1]+stimdur)
                setthistime.push(setthistime[setthistime.length-1]+delay)
             }

             
             for (iSeq = 0; iSeq < nSeq; iSeq++){
                //call initialT for each cue: inputs color array for painting, time at the end of previous cue(start new cue), and sound
                initialT(testcolors[iSeq],setthistime[2*iSeq],soundlist[iSeq]);

                RemoveStim(setthistime[(2*iSeq)+1]);
                if (iSeq == nSeq-1){
                  Cue(setthistime[setthistime.length-1]);
                }
             }
          }

          // function initPicture(){
            // var picture = document.getElementById('picture');
            // picture.src = imgSrc + imgList[curTrial];
          // }

          // document.addEventListener("DOMContentLoaded", function () {
            //  initPicture();
            //  $('#startExperiment').click(TOK);
          // })

          function initialT(color,waittime,sound){
            
            setTimeout(function(){
                // Draw stimuli
                erase(ctx1);
                clear();
                makeBackground(bgcolor[bgx]);

                makeBackground(bgcolor[bgx]);
                makeCircles(color,borders);
                makeCrosshair();
                drawObjects(ctx1,objects);
                var audio = document.getElementById(sound);

                // audio.play();
                var dT = new Date();
                STT=dT.getTime();
            },waittime);
          }
            

          function RemoveStim(waittime2){    
            // Remove stimuli
            setTimeout(function(){
                erase(ctx1);
                clear();
                makeBackground(bgcolor[bgx])
                makeCircles(nullcolor,borders);
                makeCrosshair();
                drawObjects(ctx1,objects);
                var dST = new Date();
                realstimtime.push(dST.getTime()-STT);
                var dST2 = new Date();
                ST2 = dST2.getTime();
            },waittime2);
          }


          function Cue(waittime3){
            /**
             * Wait for waittime3 before execute of the sequence in function 
             * @param {int} waittime3 time in ms to wait before execution 
             **/
            setTimeout(function(){
                var dST3 = new Date();
                //realdelaytime.push(dST3.getTime()-ST2);
                erase(ctx1); //ctx1 is context from myCanvas objecty in html
                clear();
                
                currProbe=0;
                moveLast = 0 ;
                makeBackground(bgcolor[bgx])
                makeCircles(nullcolor,borders);
                makeCrosshair();
                drawObjects(ctx1,objects);
                
                
                startTime();
                console.log('now!')
                isTest=true;
            },waittime3);
        }

        function Feedback(){    
            // Remove stimuli
            setTimeout(function(){
                erase(ctx1);
                clear();
                makeBackground(bgcolor[bgx])
                makeCircles(nullcolor,borders);
                makeCrosshair();
                drawObjects(ctx1,objects);
                trialIsOver();
            },feedbacktime);
          }

        function showFirstTrial() {
            
            isTrain = false;


            // Draw first fixation 
            // makeCrosshair();
            // drawObjects(ctx1,objects);

            // Begin
            $("#myCanvas").show();
            $('#frame1').hide();
            // $('#rule0').show();
            if (curTrial == 0) {
                    bgx = 1;
                }
            makeBackground(bgcolor[bgx])
            showTrial();
            startTrialTime = new Date();
            // $('.trialDiv').hide();

        }

        function showPractice_f1(){
            // document.getElementById("backgroundsound").loop = true;
            // var bgsound = document.getElementById('backgroundsound');
            // document.getElementById("backgroundsound2").loop = true;
            // var bgsound2 = document.getElementById('backgroundsound2');

            // var vol = 0.00;
            // var interval = 100; // 200ms interval

            // var fadein= setInterval(
            //   function() {
            //     if (vol < 0.3) {
            //       vol += 0.05;
            //       bgsound.volume = vol;
            //       bgsound2.volume = vol+0.4;
            //     }
            //     else {
            //       // Stop the setInterval when 0 is reached
            //       clearInterval(fadein);
            //     }
            //   }, interval)
            // bgsound2.volume = 0.4;
            // bgsound.volume = 0.3;
            // bgsound.play();
            // bgsound2.play();

            // for (isound = 0; isound<soundlist.length; isound++){
              // var tempaudio = document.getElementById(soundlist[isound]);
              // tempaudio.play();
              // tempaudio.pause();
            // }

            if ($(window).width() >= 300 && screen.width*.4 < $(window).width()){
                $('#introductions').hide();
                // $('.instructions').show();
                $("#myCanvas").hide();
                // myCanvas.style.border = 'solid' 
                 // Draw first fixation 
                // makeCrosshair();
                // makeCircles(nullcolor,borders);
                // drawObjects(ctx1,objects);
                $('#frame1').show();
                // Begin
                $('#cont1').on('click',pressed);
                function pressed(){
                  showFirstTrial();
                }
            }

        }

        function showPractice_f2(){
            $('#introductions').hide();
            $('#frame1').hide();
            var jj = Math.round(Math.random(1)*numDots);
            const temp = Object.values(Object.assign({}, testtemp));
            temp[jj] = 20;
            testcolor = paintcolor(temp);
            makeCrosshair();
            makeCircles(testcolor,borders);
            drawObjects(ctx1,objects);
            $('#frame2').show();
            $('#cont2').click(showPractice_f3);
        }

        function showPractice_f3(){
            $('#frame2').hide();
            makeCrosshair();
            makeCircles(nullcolor,borders);
            drawObjects(ctx1,objects);
            $('#frame3').show();
            $('#cont3').click(showPractice_f4);
        }

        function showPractice_f4(){

                order = [0,3]; 
                wrot = 0;  
                // isTrain = true;
                // console.log(order)
                $('#frame3').hide();
                currProbe=0;
                makeCrosshair();
                drawObjects(ctx1,objects);
                
                $('#frame4').show();
                $('#cont4').click(showPractice_f5);
        }

        function showPractice_f5(){

            $('#frame4').hide();
            // erase(ctx1);
            clear();
            makeCrosshair();
            makeCircles(nullcolor,borders);
            drawObjects(ctx1,objects);
            $('#frame5').show();
            $('#cont5').click(showFirstTrial);
        }

        function Done() {

            $("#myCanvas").hide();
              $("#done").show();

              var dataToServer = {};
              dataToServer.id = getParameterByName("subjectId"); /* getParameterByName("code") */
              dataToServer.experimenter = 'Chaipat';
              dataToServer.experimentName = 'WMcolordist_delay';
              dataToServer.curData = JSON.stringify(trialStruct);
              $.post("https://psyc241.ucsd.edu/Turk/save.php", dataToServer, AfterSuccessDataSaving).fail(AfterFailedSaving);
        }

        function AfterSuccessDataSaving() {
          // After they are done, send them here:
          // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");
          $('#submitButton').show();
          $('#done').html("All done, thanks! Please click submit button.");
          
          console.log("Saved!");
        }

        function AfterFailedSaving() {
          console.log("oops, failed to save");

          // window.location = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=1267&credit_token=805f6634de5a46b3aecffe2818d8d90c&survey_code=" + getParameterByName("code");  
          $('#submitButton').show();
          $('#done').html("All done, thanks! Please click submit button.");

        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }


        // ========================================================= 
        $('#startExperiment').click(showPractice_f1);
        $('.responseButton').click(trialIsOver);
        // =========================================================

        /**
         * Gets a URL parameter from the query string
         */
        function turkGetParam( name, defaultValue ) { 
           var regexS = "[\?&]"+name+"=([^&#]*)"; 
           var regex = new RegExp( regexS ); 
           var tmpURL = window.location.href; 
           var results = regex.exec( tmpURL ); 
           if( results == null ) { 
             return defaultValue; 
           } else { 
             return results[1];    
           } 
        }

        function GetWorkerId() {
          var workerId = turkGetParam( 'workerId', 'NONE' );
          return workerId;
        } 

        function IsTurkPreview() {
          return GetWorkerId() == "NONE";
        } 

        function IsOnTurk() {
          try {
            return ((window.location.host.indexOf('mturk')!=-1) || document.forms["mturk_form"] ||
              (top != self && window.parent.location.host.indexOf("mturk") != -1));
          } catch(err) {
            // insecure content trying to access https://turk probably, so say yes:
            return true;
          }
        }
        </script>


